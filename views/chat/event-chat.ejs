<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/partials.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <% if (locals.showNavbar !== false) { %>
        <%- include('../partials/navbar') %>
    <% } %>
    
    <main class="main-content">
<div class="chat-container">
    <div class="chat-header">
        <div class="chat-info">
            <h2 class="chat-title">
                <i class="fas fa-comments"></i>
                <%= event.name %> Chat
            </h2>
            <div class="chat-meta">
                <span class="event-date">
                    <i class="fas fa-calendar"></i>
                    <%= new Date(event.date).toLocaleDateString() %>
                </span>
                <span class="participant-count">
                    <i class="fas fa-users"></i>
                    <%= event.attendees?.length || 0 %> participants
                </span>
            </div>
        </div>
        
        <div class="chat-actions">
            <a href="/events/<%= event._id %>" class="btn btn-outline btn-sm">
                <i class="fas fa-arrow-left"></i>
                Back to Event
            </a>
        </div>
    </div>
    
    <div class="chat-content">
        <div class="messages-container" id="messagesContainer">
            <% if (messages && messages.length > 0) { %>
                <% messages.forEach(message => { %>
                    <div class="message <%= message.sender._id === user.id ? 'own-message' : 'other-message' %>">
                        <div class="message-avatar">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        
                        <div class="message-content">
                            <div class="message-header">
                                <span class="sender-name"><%= message.sender.name %></span>
                                <span class="message-time">
                                    <%= new Date(message.createdAt).toLocaleTimeString() %>
                                </span>
                            </div>
                            
                            <div class="message-text">
                                <%= message.content %>
                            </div>
                        </div>
                    </div>
                <% }) %>
            <% } else { %>
                <div class="empty-chat">
                    <i class="fas fa-comments"></i>
                    <p>No messages yet. Start the conversation!</p>
                </div>
            <% } %>
        </div>
        
        <div class="message-input-container">
            <form id="messageForm" class="message-form">
                <div class="input-group">
                    <input type="text" id="messageInput" class="message-input" 
                           placeholder="Type your message..." maxlength="500" required>
                    <button type="submit" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const eventId = '<%= event._id %>';
const userId = '<%= user.id %>';
const userName = '<%= user.name %>';

// Message form handling
document.getElementById('messageForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const sendButton = this.querySelector('.send-button');
    const content = messageInput.value.trim();
    
    // Validate empty message
    if (!content) {
        showToast('Message cannot be empty', 'error');
        return;
    }
    
    // Validate message length
    if (content.length > 500) {
        showToast('Message cannot exceed 500 characters', 'error');
        return;
    }
    
    // Show loading state
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                content: content,
                eventId: eventId,
                type: 'event'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageInput.value = '';
            showToast('Message sent successfully', 'success');
            
            // Add message immediately for better UX
            addMessage({
                sender: { _id: userId, name: userName },
                content: content,
                createdAt: new Date().toISOString()
            });
        } else {
            showToast(result.message || 'Failed to send message', 'error');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Network error. Please try again.', 'error');
    } finally {
        // Reset button state
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
});

// Auto-scroll to bottom
function scrollToBottom() {
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

// Add new message to chat
function addMessage(message) {
    const container = document.getElementById('messagesContainer');
    const isOwnMessage = message.sender._id === userId;
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isOwnMessage ? 'own-message' : 'other-message'}`;
    
    messageElement.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-user-circle"></i>
        </div>
        
        <div class="message-content">
            <div class="message-header">
                <span class="sender-name">${escapeHtml(message.sender.name)}</span>
                <span class="message-time">
                    ${new Date(message.createdAt).toLocaleTimeString()}
                </span>
            </div>
            
            <div class="message-text">
                ${escapeHtml(message.content)}
            </div>
        </div>
    `;
    
    // Remove empty chat message if it exists
    const emptyChat = container.querySelector('.empty-chat');
    if (emptyChat) {
        emptyChat.remove();
    }
    
    container.appendChild(messageElement);
    scrollToBottom();
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Poll for new messages
let lastMessageTime = new Date().toISOString();
let isPolling = false;

async function pollMessages() {
    if (isPolling) return;
    isPolling = true;
    
    try {
        const response = await fetch(`/chat/event/${eventId}/messages?since=${encodeURIComponent(lastMessageTime)}`);
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.data && result.data.length > 0) {
                result.data.forEach(message => {
                    // Only add messages from other users to avoid duplicates
                    if (message.sender._id !== userId) {
                        addMessage(message);
                    }
                    lastMessageTime = message.createdAt;
                });
            }
        } else {
            console.warn('Failed to poll messages:', response.status);
        }
    } catch (error) {
        console.error('Error polling messages:', error);
    } finally {
        isPolling = false;
    }
}

// Start polling every 3 seconds
setInterval(pollMessages, 3000);

// Initial scroll to bottom
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
    
    // Focus on message input
    document.getElementById('messageInput').focus();
});

// Handle Enter key for sending messages
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});

// Character counter
document.getElementById('messageInput').addEventListener('input', function() {
    const remaining = 500 - this.value.length;
    if (remaining < 50) {
        if (!document.querySelector('.char-counter')) {
            const counter = document.createElement('div');
            counter.className = 'char-counter';
            counter.style.cssText = 'font-size: 12px; color: #666; margin-top: 4px;';
            this.parentNode.appendChild(counter);
        }
        document.querySelector('.char-counter').textContent = remaining + ' characters remaining';
        document.querySelector('.char-counter').style.color = remaining < 10 ? '#e74c3c' : '#666';
    } else {
        const counter = document.querySelector('.char-counter');
        if (counter) counter.remove();
    }
});
</script>
    </main>
    
    <% if (locals.showNavbar !== false) { %>
        <%- include('../partials/footer') %>
    <% } %>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>
    
    <script src="/js/main.js"></script>
    <script src="/js/partials.js"></script>
    <script src="/js/notifications.js"></script>
</body>
</html>